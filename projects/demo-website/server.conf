# =============================
# HTTP (80): ACME challenge + redirect to HTTPS
# =============================
server {
  listen 80;
  listen [::]:80;
  server_name ${MAIN_DOMAIN_NAME} ${DOMAIN_ALIASES};

  # --- ACME challenge (Let's Encrypt HTTP-01) ---
  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }

  # --- All other HTTP â†’ HTTPS ---
  return 301 https://$host$request_uri;
}

# =============================
# HTTPS (443): TLS + proxy
# =============================
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name ${MAIN_DOMAIN_NAME} ${DOMAIN_ALIASES};

  # --- TLS certs (primary name dir even if SANs are present) ---
  ssl_certificate     /etc/letsencrypt/live/${MAIN_DOMAIN_NAME}/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/${MAIN_DOMAIN_NAME}/privkey.pem;

  # --- Static files ---
  location /static/ {
    alias /shared-files/${MAIN_DOMAIN_NAME}/static/;
  }

  # --- Media files ---
  location /media/ {
    alias /shared-files/${MAIN_DOMAIN_NAME}/media/;
  }

  # --- App proxy ---
  location / {
    proxy_set_header Host                $host;
    proxy_set_header X-Real-IP           $remote_addr;
    proxy_set_header X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto   $scheme;
    #proxy_read_timeout     60s;
    #proxy_connect_timeout   5s;
    #proxy_send_timeout     60s;
    proxy_pass http://${DOCKER-COMPOSE-SERVICE-NETWORK-ALIAS}:${APP_PORT};
  }
}
