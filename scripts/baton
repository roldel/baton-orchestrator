#!/bin/sh
# scripts/baton - Main CLI entrypoint
# Resolves symlink â†’ finds real scripts/ dir

set -e

# Resolve real path of this script (follow symlink)
if [ -L "$0" ]; then
    REAL_PATH=$(readlink -f "$0")
else
    REAL_PATH="$0"
fi

REAL_DIR=$(CDPATH= cd -- "$(dirname -- "$REAL_PATH")" && pwd)

# Source env-setup
ENV_SETUP="$REAL_DIR/../env-setup.sh"
if [ ! -f "$ENV_SETUP" ]; then
    echo "ERROR: env-setup.sh not found at $ENV_SETUP" >&2
    echo "Check baton-orchestrator installation." >&2
    exit 1
fi

. "$ENV_SETUP"

# Route command
CMD="$1"
shift || true

case "$CMD" in
    deploy|update-server-conf|ssl-renew-now|stand-down)
        exec "$SCRIPT_DIR/cmd/${CMD}.sh" "$@"
        ;;
    help|--help|-h)
        cat << EOF
baton-orchestrator CLI

Commands:
  baton deploy <project>           Deploy site
  baton stand-down <project>       Remove site
  baton help                       This help
EOF
        exit 0
        ;;
    *)
        echo "Unknown command: $CMD" >&2
        echo "Use 'baton help'" >&2
        exit 1
        ;;
esac