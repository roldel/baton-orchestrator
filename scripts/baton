#!/bin/sh
# baton â€” CLI entrypoint (resolves repo root; exports BASE_DIR)
set -eu

if [ -L "$0" ]; then
  BATON_PATH=$(readlink -f "$0" 2>/dev/null || echo "$0")
else
  BATON_PATH="$0"
fi

REPO_ROOT=$(CDPATH= cd -- "$(dirname -- "$BATON_PATH")/.." && pwd)
export BASE_DIR="$REPO_ROOT"

ENV_SETUP="$REPO_ROOT/env-setup.sh"
[ -f "$ENV_SETUP" ] || { echo "ERROR: env-setup.sh not found at $ENV_SETUP" >&2; exit 1; }
. "$ENV_SETUP"

CMD="${1:-}"
shift || true

case "$CMD" in
  deploy|ssl-issue|ssl-renew-now|update-server-conf|stand-down)
    exec "$SCRIPT_DIR/cmd/${CMD}.sh" "$@"
    ;;
  help|--help|-h|"")
    echo "Usage: baton <deploy|ssl-issue|ssl-renew-now|update-server-conf|stand-down> <project>"
    exit 0
    ;;
  *)
    echo "Unknown command: $CMD"
    echo "Use 'baton help'"
    exit 1
    ;;
esac
